<!DOCTYPE html>
<html lang="ro" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnviroGuard IoT Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121418;
            --card-bg: #1e2228;
            --border-color: #2d323a;
            --accent-primary: #339af0;
            --accent-success: #00d25b;
            --accent-danger: #fc424a;
            --accent-warning: #ffab00;
            --text-muted: #8e9bb4;
        }

        body {
            background-color: var(--bg-dark);
            font-family: 'Inter', sans-serif;
            color: #e0e0e0;
            overflow-x: hidden; /* Previne scroll orizontal nedorit */
        }

        /* --- Navigatie --- */
        .navbar {
            background-color: var(--card-bg) !important;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 15px rgba(0,0,0,0.4);
        }
        .navbar-brand {
            font-weight: 700;
            letter-spacing: 1px;
            color: #fff !important;
        }
        
        /* --- Carduri KPI (Cele de sus) --- */
        .kpi-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-color: var(--accent-primary);
        }
        .kpi-value {
            font-family: 'Roboto Mono', monospace;
            font-size: 2rem;
            font-weight: 600;
            margin: 10px 0;
        }
        .kpi-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2.5rem;
            opacity: 0.1;
        }

        /* --- Container Principal --- */
        .main-card {
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 25px;
        }
        .card-header-custom {
            background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Grafic --- */
        .chart-container {
            position: relative;
            height: 450px; /* Inaltime fixa pentru consistenta */
            width: 100%;
            padding: 10px;
        }
        #chartMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-style: italic;
            display: none;
            pointer-events: none;
        }

        /* --- Tabel Date --- */
        .table-custom {
            font-size: 0.9rem;
        }
        .table-custom thead th {
            background-color: #252b32;
            border-bottom: 2px solid var(--border-color);
            color: #fff;
            font-weight: 500;
        }
        .table-custom tbody tr:hover {
            background-color: rgba(255,255,255,0.05);
        }

        /* --- Status Indicator (Bulina Live) --- */
        .status-badge {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 30px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            background-color: var(--text-muted);
            transition: background-color 0.3s ease;
        }
        .status-dot.live {
            background-color: var(--accent-success);
            box-shadow: 0 0 10px var(--accent-success); /* Efect de stralucire */
            animation: pulse 2s infinite;
        }
        .status-dot.error {
            background-color: var(--accent-danger);
            box-shadow: 0 0 10px var(--accent-danger);
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- Loading Overlay --- */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 20, 24, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            backdrop-filter: blur(5px);
        }

        /* --- Form Elements Tweaks --- */
        .form-control, .form-select {
            background-color: #2b3035;
            border-color: var(--border-color);
            color: #e0e0e0;
            font-size: 0.85rem;
        }
        .form-control:focus, .form-select:focus {
            background-color: #32383e;
            color: #fff;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 0.25rem rgba(51, 154, 240, 0.25);
        }
        
        /* Scrollbar personalizat */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #495057; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6c757d; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="fw-light">Initializare conexiune sistem...</h5>
        <small class="text-muted">Se conecteaza la baza de date PostgreSQL</small>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <i class="fas fa-microchip me-2 text-primary"></i>
                IoT Enviro<span class="text-primary">Monitor</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-3">
                        <div class="status-badge">
                            <span id="statusDot" class="status-dot"></span>
                            <span id="lastUpdated" class="small">Conectare...</span>
                        </div>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-success btn-sm" onclick="exportCSV()">
                            <i class="fas fa-file-csv me-1"></i> Export Date
                        </button>
                    </li>
                    <li class="nav-item ms-2">
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="fas fa-cog"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-label">Temperatura Medie</div>
                    <div class="kpi-value text-danger" id="kpi-temp">--.- °C</div>
                    <i class="fas fa-thermometer-half kpi-icon text-danger"></i>
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="prog-temp"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-label">Umiditate Relativa</div>
                    <div class="kpi-value text-info" id="kpi-hum">--.- %</div>
                    <i class="fas fa-tint kpi-icon text-info"></i>
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="prog-hum"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-label">Nivel Gaze (MQ-2)</div>
                    <div class="kpi-value text-warning" id="kpi-gas">---</div>
                    <i class="fas fa-smog kpi-icon text-warning"></i>
                    <small class="text-muted" id="gas-status">Asteptare date...</small>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-label">Ultima Actualizare</div>
                    <div class="kpi-value text-success" style="font-size: 1.5rem;" id="kpi-time">--:--:--</div>
                    <i class="fas fa-clock kpi-icon text-success"></i>
                    <small class="text-muted">Sincronizare server</small>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="main-card p-3">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="text-secondary small mb-1 fw-bold">Interval Rapid</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-secondary btn-sm" onclick="setRange(1)">1h</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="setRange(6)">6h</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="setRange(24)">24h</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="setRange(168)">7d</button>
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="text-secondary small mb-1">De la (Start)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-dark border-secondary"><i class="far fa-calendar-alt"></i></span>
                                <input type="text" id="fromDate" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="text-secondary small mb-1">Pana la (Stop)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-dark border-secondary"><i class="far fa-calendar-alt"></i></span>
                                <input type="text" id="toDate" class="form-control">
                            </div>
                        </div>

                        <div class="col-md-2">
                            <label class="text-secondary small mb-1">Parametru Focus</label>
                            <select id="sensorSelect" class="form-select form-select-sm">
                                <option value="all">Toți Parametrii</option>
                                <option value="temperature">Temperatură (°C)</option>
                                <option value="humidity">Umiditate (%)</option>
                                <option value="gas">Concentrație Gaze</option>
                            </select>
                        </div>

                        <div class="col-md-3 ms-auto">
                            <div class="d-flex flex-column align-items-end">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="liveScroll" checked>
                                    <label class="form-check-label text-secondary small" for="liveScroll">
                                        <i class="fas fa-sync fa-spin text-primary me-1"></i> Live Scroll (Auto)
                                    </label>
                                </div>
                                <button id="applyFilters" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-filter me-1"></i> Actualizare Grafic
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="main-card">
                    <div class="card-header-custom">
                        <span>
                            <i class="fas fa-chart-line me-2 text-primary"></i> Evoluție Temporală
                        </span>
                        <button class="btn btn-outline-secondary btn-sm py-0" onclick="chart.resetZoom()">
                            <i class="fas fa-search-minus me-1"></i> Reset Zoom
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="sensorChart"></canvas>
                            <div id="chartMessage">Nu există date pentru perioada selectată</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="main-card">
                    <div class="card-header-custom">
                        <span><i class="fas fa-table me-2 text-warning"></i> Jurnal Date Brut (Log)</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="sensorTable" class="table table-custom table-dark table-hover w-100 align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-3">ID Inreg.</th>
                                        <th class="text-danger"><i class="fas fa-temperature-high me-1"></i> Temp</th>
                                        <th class="text-info"><i class="fas fa-tint me-1"></i> Hum</th>
                                        <th class="text-success">MQ-2 (Gen)</th>
                                        <th class="text-warning">MQ-9 (CO)</th>
                                        <th class="text-primary">MQ-135 (Air)</th>
                                        <th class="text-secondary"><i class="far fa-clock me-1"></i> Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="mt-4 pb-3 text-center text-muted small">
        <hr class="border-secondary mx-4">
        <p class="mb-0">
            &copy; 2024 Sistem Monitorizare Mediu. Proiectat cu Arduino & Python. 
            <br>Frontend v2.1 | Chart.js 4.0 | Bootstrap 5
        </p>
    </footer>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark border-secondary text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Configurare Sistem</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Setari interfata (Client-Side)</p>
                    <div class="mb-3">
                        <label class="form-label">Interval Refresh (ms)</label>
                        <select class="form-select" id="refreshRate">
                            <option value="1000">1 Secunda (Rapid)</option>
                            <option value="3000" selected>3 Secunde (Recomandat)</option>
                            <option value="5000">5 Secunde (Economic)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limită Puncte Live</label>
                        <input type="number" class="form-control" value="30" id="maxPointsInput">
                        <div class="form-text text-muted">Cate puncte se afiseaza in modul "Live Scroll"</div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Inchide</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveSettings()">Salveaza</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
    /**
     * ============================================================
     * COD PRINCIPAL JAVASCRIPT
     * Responsabilitati: 
     * 1. Fetch date din backend API
     * 2. Gestionare Grafic Chart.js (cu Sliding Window)
     * 3. Gestionare Tabel DataTable
     * 4. Calcul KPI in timp real
     * ============================================================
     */

    // --- VARIABILE GLOBALE & CONFIGURARE ---
    const fpConfig = { 
        enableTime: true, 
        dateFormat: "Y-m-d H:i", 
        time_24hr: true, 
        theme: "dark",
        static: true // Previne inchiderea la scroll
    };
    const fpFrom = flatpickr("#fromDate", fpConfig);
    const fpTo = flatpickr("#toDate", fpConfig);

    let rawData = [];      // Stocare locala a datelor brute
    let table;             // Instanta DataTable
    let chart;             // Instanta Chart.js
    let refreshInterval;   // Timer pentru fetch
    
    // Setari default
    let SETTINGS = {
        maxLivePoints: 30, // Cati pasi tinem in grafic cand e live
        refreshMs: 3000    // La cate milisecunde cerem date noi
    };

    // --- INITIALIZARE LA INCARCAREA PAGINII ---
    $(document).ready(function() {
        // 1. Initializare Componente UI
        initTable();
        initChart();
        
        // 2. Setare stare initiala (ultimele 24 ore)
        setRange(24);
        
        // 3. Pornire bucla de date
        fetchData(); 
        startRefreshTimer();

        // 4. Atasare Evenimente (Listeners)
        $('#applyFilters').on('click', function() {
            // La update manual, oprim modul Live ca userul sa vada istoricul cerut
            document.getElementById('liveScroll').checked = false;
            applyFilters();
        });
        
        $('#sensorSelect').on('change', applyFilters);
        
        // Cand userul reactiveaza Live Scroll, resetam timpul la "Acum"
        $('#liveScroll').on('change', function() {
            if(this.checked) {
                setRange(24); 
                // Re-porneste timerul daca a fost oprit accidental
                startRefreshTimer();
            }
            applyFilters();
        });
    });

    // --- FUNCTII DE FETCHING (COMUNICARE CU SERVERUL) ---
    async function fetchData() {
        try {
            // TEHNICA "CACHE BUSTING":
            // Adaugam parametrul ?t=timestamp pentru a forta browserul 
            // sa nu foloseasca versiunea cached a JSON-ului.
            const url = '/api/sensor_data?t=' + new Date().getTime();
            
            const response = await fetch(url);
            
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const json = await response.json();
            
            // Procesare si Normalizare Date
            rawData = json.map(r => {
                let item = {};
                // Suport atat pentru Array (Postgres Tuple) cat si JSON Object
                if (Array.isArray(r)) {
                    item = { 
                        id: r[0], 
                        temperature: r[1], 
                        humidity: r[2], 
                        mq2: r[3], 
                        mq9: r[4], 
                        mq135: r[5], 
                        timestamp: r[6] 
                    };
                } else {
                    item = r;
                }

                // Conversii numerice de siguranta
                item.temperature = item.temperature ? parseFloat(item.temperature) : null;
                item.humidity = item.humidity ? parseFloat(item.humidity) : null;
                item.mq2 = parseInt(item.mq2) || 0;
                item.mq9 = parseInt(item.mq9) || 0;
                item.mq135 = parseInt(item.mq135) || 0;
                
                // Obiect Date JavaScript
                item.timestampObj = new Date(item.timestamp); 
                item.timestampString = item.timestampObj.toLocaleString("ro-RO", {hour12: false});
                
                return item;
            });

            // Sortare Cronologica (Vechi -> Nou)
            rawData.sort((a, b) => a.timestampObj - b.timestampObj);

            // LOGICA CRITICA PENTRU LIVE UPDATE:
            // Daca suntem in mod Live, "Impingem" data de final (To Date) la momentul curent
            // Altfel, datele noi ar fi filtrate pentru ca depasesc timpul selectat initial.
            if (document.getElementById('liveScroll').checked) {
                fpTo.setDate(new Date());
            }

            // Actualizare UI
            document.getElementById('loadingOverlay').style.display = 'none';
            updateStatus(true);
            updateDashboardCards(); // Update KPI Cards
            applyFilters();         // Update Grafic si Tabel

        } catch (e) {
            console.error("Eroare la preluarea datelor:", e);
            updateStatus(false);
        }
    }

    function startRefreshTimer() {
        if(refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(fetchData, SETTINGS.refreshMs);
    }

    // --- FUNCTII UI: DASHBOARD CARDS ---
    function updateDashboardCards() {
        if (!rawData || rawData.length === 0) return;

        // Luam ultima inregistrare
        const last = rawData[rawData.length - 1];

        // 1. Update Temperatura
        $('#kpi-temp').text(`${last.temperature ? last.temperature.toFixed(1) : '--'} °C`);
        let tempPercent = Math.min((last.temperature / 50) * 100, 100); // 50 grade max
        $('#prog-temp').css('width', tempPercent + '%');

        // 2. Update Umiditate
        $('#kpi-hum').text(`${last.humidity ? last.humidity.toFixed(1) : '--'} %`);
        $('#prog-hum').css('width', last.humidity + '%');

        // 3. Update Gaz & Status
        $('#kpi-gas').text(last.mq2);
        const gasLabel = $('#gas-status');
        
        // Logica simpla de status calitate aer
        if (last.mq2 < 200) {
            gasLabel.html('<span class="text-success"><i class="fas fa-check-circle"></i> Aer Curat</span>');
        } else if (last.mq2 < 450) {
            gasLabel.html('<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Atenție</span>');
        } else {
            gasLabel.html('<span class="text-danger"><i class="fas fa-radiation"></i> PERICOL!</span>');
        }

        // 4. Update Timp
        const timeStr = last.timestampObj.toLocaleTimeString("ro-RO");
        $('#kpi-time').text(timeStr);
    }

    // --- CONFIGURARE CHART.JS ---
    function initChart() {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        
        // Creare Gradient pentru Temperatura (Vizual mai placut)
        let gradientTemp = ctx.createLinearGradient(0, 0, 0, 400);
        gradientTemp.addColorStop(0, 'rgba(252, 66, 74, 0.5)');   // Rosu sus
        gradientTemp.addColorStop(1, 'rgba(252, 66, 74, 0.0)');   // Transparent jos

        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false, // OPRIT pentru performanta in timp real
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#ccc',
                        borderColor: '#444',
                        borderWidth: 1
                    },
                    legend: { labels: { color: '#ccc', usePointStyle: true } }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { 
                            tooltipFormat: 'HH:mm:ss',
                            displayFormats: {
                                second: 'HH:mm:ss',
                                minute: 'HH:mm'
                            }
                        },
                        grid: { color: '#2d323a' },
                        ticks: { color: '#8e9bb4', maxRotation: 0, autoSkip: true }
                    },
                    y: { 
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Valori Ambientale', color: '#8e9bb4' },
                        grid: { color: '#2d323a' },
                        ticks: { color: '#8e9bb4' }
                    },
                    y1: { 
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'PPM (Gaze)', color: '#ffab00' },
                        grid: { drawOnChartArea: false }, // Ascunde gridul pentru axa secundara
                        ticks: { color: '#ffab00' }
                    }
                }
            }
        });
        
        // Salvam gradientul in obiectul chart pentru refolosire
        chart.customGradient = gradientTemp;
    }

    // --- CONFIGURARE DATATABLE ---
    function initTable() {
        table = $('#sensorTable').DataTable({
            columns: [
                {data: 'id', width: "5%"},
                {data: 'temperature', render: (d) => `<span class="fw-bold text-light">${d}</span>`},
                {data: 'humidity', render: (d) => `${d}%`},
                {data: 'mq2'},
                {data: 'mq9'},
                {data: 'mq135'},
                {data: 'timestampString', className: "text-muted font-monospace"}
            ],
            order: [[6, 'desc']], // Sortare dupa timp descrescator
            pageLength: 5,       // Doar 5 randuri pentru a nu ocupa spatiu
            lengthChange: false, // Ascunde selectorul de "entries per page"
            searching: false,    // Ascunde bara de cautare (clean UI)
            info: false,         // Ascunde "Showing 1 of X entries"
            language: { emptyTable: "Se asteapta date de la senzori..." },
            rowCallback: function(row, data) {
                // Colorare randuri daca valorile sunt critice (optional)
                if (data.mq2 > 300) {
                    $('td', row).addClass('text-warning');
                }
            }
        });
    }

    // --- LOGICA DE FILTRARE SI RANDARE ---
    function applyFilters() {
        const from = fpFrom.selectedDates[0];
        const to = fpTo.selectedDates[0];
        const type = document.getElementById('sensorSelect').value;
        const isLiveMode = document.getElementById('liveScroll').checked;

        // 1. Filtrare in Memorie (Client-Side)
        let filtered = rawData.filter(r => {
            if(!r.timestampObj) return false;
            let validStart = (!from || r.timestampObj >= from);
            let validEnd = (!to || r.timestampObj <= to);
            return validStart && validEnd;
        });

        // 2. Actualizare Tabel
        // Clonam si inversam pentru a avea cele mai noi sus
        let tableData = [...filtered].reverse().map(r => ({
            ...r,
            temperature: r.temperature !== null ? r.temperature.toFixed(1) : "-",
            humidity: r.humidity !== null ? r.humidity.toFixed(1) : "-"
        }));
        
        table.clear();
        table.rows.add(tableData).draw(false);

        // 3. Pregatire Date Grafic
        const chartMsg = document.getElementById('chartMessage');
        if (filtered.length === 0) {
            chartMsg.style.display = 'block';
            chart.data.datasets = [];
            chart.update();
            return;
        } else {
            chartMsg.style.display = 'none';
        }

        // --- SLIDING WINDOW LOGIC ---
        // Daca e LIVE, taiem array-ul sa pastram doar ultimele X puncte
        // Asta creaza efectul de "scrolling" fara sa inghesuie graficul
        let chartData = filtered;
        if (isLiveMode && filtered.length > SETTINGS.maxLivePoints) {
            chartData = filtered.slice(-SETTINGS.maxLivePoints); 
        }

        updateChartData(chartData, type);
    }

    function updateChartData(data, type) {
        // Helper pentru mapare
        const mapD = (key) => data.map(r => ({ x: r.timestampObj, y: r[key] }));

        // Definitie Dataset-uri
        let datasets = [
            { 
                label: 'Temperatură', 
                data: mapD('temperature'), 
                borderColor: '#fc424a', 
                backgroundColor: chart.customGradient || 'rgba(252, 66, 74, 0.2)', 
                fill: true, 
                yAxisID: 'y', 
                pointRadius: 2, 
                tension: 0.4 // Curbura liniei (0 = drept, 1 = foarte curb)
            },
            { 
                label: 'Umiditate', 
                data: mapD('humidity'), 
                borderColor: '#339af0', 
                backgroundColor: 'transparent', 
                yAxisID: 'y', 
                pointRadius: 2, 
                tension: 0.4 
            },
            { 
                label: 'MQ-2 (Gaz)', 
                data: mapD('mq2'), 
                borderColor: '#00d25b', 
                borderDash: [5, 5], // Linie punctata
                yAxisID: 'y1', 
                pointRadius: 0, 
                borderWidth: 1.5 
            },
            { 
                label: 'MQ-9 (CO)', 
                data: mapD('mq9'), 
                borderColor: '#ffab00', 
                borderDash: [5, 5], 
                yAxisID: 'y1', 
                pointRadius: 0, 
                borderWidth: 1.5 
            },
            { 
                label: 'MQ-135 (Air)', 
                data: mapD('mq135'), 
                borderColor: '#8f5fe8', 
                borderDash: [2, 2], 
                yAxisID: 'y1', 
                pointRadius: 0, 
                borderWidth: 1.5 
            }
        ];

        // Filtrare vizuala in functie de dropdown
        let visibleDatasets = [];
        if(type === 'all') visibleDatasets = datasets;
        else if(type === 'temperature') visibleDatasets = [datasets[0]];
        else if(type === 'humidity') visibleDatasets = [datasets[1]];
        else if(type === 'gas') visibleDatasets = [datasets[2], datasets[3], datasets[4]];

        chart.data.datasets = visibleDatasets;
        
        // Folosim 'none' mode la update pentru performanta maxima in animatie
        chart.update('none'); 
    }

    // --- FUNCTII UTILITARE & EVENT HANDLERS ---
    
    // Seteaza intervalul de timp (ex: Ultimele 24h)
    function setRange(hours) {
        const end = new Date();
        const start = new Date(end.getTime() - (hours * 3600000));
        
        fpFrom.setDate(start);
        fpTo.setDate(end);
        
        // Cand setam un range preset, pornim automat modul Live
        document.getElementById('liveScroll').checked = true;
        
        applyFilters();
    }

    // Actualizeaza indicatorul vizual de status conexiune
    function updateStatus(isLive) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('lastUpdated');
        
        if (isLive) {
            dot.className = 'status-dot live';
            text.innerHTML = `ONLINE <span class="text-muted ms-1">| ${new Date().toLocaleTimeString()}</span>`;
            text.classList.remove('text-danger');
        } else {
            dot.className = 'status-dot error';
            text.innerText = "OFFLINE / EROARE API";
            text.classList.add('text-danger');
        }
    }

    // Exporta datele afisate in format CSV
    function exportCSV() {
        if(!rawData.length) return alert("Nu există date de exportat!");
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "ID,Temperature,Humidity,MQ2,MQ9,MQ135,ISO_Timestamp\n"; // Header
        
        rawData.forEach(r => {
            const row = `${r.id},${r.temperature},${r.humidity},${r.mq2},${r.mq9},${r.mq135},${r.timestamp}`;
            csvContent += row + "\r\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        const dateStr = new Date().toISOString().slice(0,10);
        
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `sensor_logs_${dateStr}.csv`);
        document.body.appendChild(link);
        
        link.click();
        document.body.removeChild(link);
    }

    // Salvare setari din Modal
    function saveSettings() {
        const rate = document.getElementById('refreshRate').value;
        const pts = document.getElementById('maxPointsInput').value;
        
        SETTINGS.refreshMs = parseInt(rate);
        SETTINGS.maxLivePoints = parseInt(pts);
        
        startRefreshTimer(); // Restart timer cu noua viteza
        
        // Inchide modal (Bootstrap API)
        const modalEl = document.getElementById('settingsModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        
        alert("Configuratia a fost salvata!");
    }
    </script>
</body>
</html>